var getElem=function(e){return document.querySelector(e)},getElems=function(e){return document.querySelectorAll(e)};function htmlToNode(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}function replaceNode(e,t){t.parentNode.replaceChild(htmlToNode(e),t)}let oldVideo=getElem("#myVideo"),newVideo=`<div class="left ecran">\n                    ${oldVideo.outerHTML}\n                    <div class="countDown">\n                        <span>Be ready : </span><span id="countDown">3</span>\n                    </div>\n                </div>`;oldVideo.parentNode.insertAdjacentHTML("afterend",'<div class="row clear">\n    <div id="errors"></div>\n</div>'),replaceNode(newVideo,oldVideo);let oldCanvas=getElem("#canvas"),newCanvas=`\n<div class="left result">\n    <div class="imgContainer">\n        ${oldCanvas.outerHTML}\n    </div>\n    <div id="btns">\n        <button class="btn" id="capturer">Capture</button>\n        <button class="btn hidden" id="resize">recadrer</button>\n        <button class="btn hidden" id="crop">crop</button>\n        <button class="btn hidden" id="cancelResize">cancel</button>\n        <a class="hidden" id="download" download="image.png"><button class="btn" type="button" onClick="download()">Download</button></a>\n    </div>\n    <div class="controles hidden">\n        <div>\n            <span>- contraste</span>\n            <input class="slider" type="range" onchange="changeContrast(this.value)" min="0" max="200" step="1" value="100">\n        </div>\n        <div>\n            <span>- Brightness</span>\n            <input class="slider" type="range" onchange="changeBrightness(this.value)" min="0" max="200" step="1" value="100">\n        </div>\n        <div>\n            <span>- Saturate</span>\n            <input class="slider" type="range" onchange="changeSaturate(this.value)" min="0" max="200" step="1" value="100">\n        </div>\n        <div>\n            <span>- Grayscale</span>\n            <input class="slider" type="range" onchange="changeGrayscale(this.value)" min="0" max="100" step="1" value="0">\n        </div>\n    </div>\n</div>`;replaceNode(newCanvas,oldCanvas);let myVideo,canvas,capturer,rescanvas,originalPhoto,image,cropWidth,cropHeight,rect,isEditable=!1,isCapture=!1,cropX=0,cropY=0;function showModule(e){document.getElementById("module").classList.remove("hidden"),e&&document.getElementById("welcome").classList.add("hidden"),display_video()}function cropInit(e){e||showModule(!1)}function display_video(){if(myVideo=document.getElementById("myVideo"),(capturer=document.getElementById("capturer")).addEventListener("click",capture),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia)navigator.getUserMedia({video:!0},success,error);else{console.log("Le navigateur ne supporte pas l'interface multimédia");var e=document.createElement("source");e.setAttribute("src","default_video.mp4"),myVideo.appendChild(e),myVideo.play(),document.getElementById("errors").innerHTML="Le navigateur ne supporte pas l'interface multimédia"}}function error(e){console.log("error : "+e);var t=document.createElement("source");t.setAttribute("src","default_video.mp4"),myVideo.appendChild(t),myVideo.play(),document.getElementById("errors").innerHTML="Le navigateur ne supporte pas l'interface multimédia"}function success(e){myVideo.srcObject=e}function capture(){countDown=document.getElementById("countDown");let e=3;var t=setInterval(function(){if(e<0)return isCapture=!0,console.log("Button is clicked"),rescanvas.drawImage(myVideo,0,0,canvas.width,canvas.height),originalPhoto=rescanvas.getImageData(0,0,canvas.width,canvas.height),(image=new Image).src=canvas.toDataURL(),clearInterval(t),getElem("#resize").classList.remove("hidden"),getElem("#download").classList.remove("hidden"),void getElem(".controles").classList.remove("hidden");countDown.innerText=e,e--},1e3)}function download(){var e=document.getElementById("download"),t=document.getElementById("canvas").toDataURL("image/png").replace("image/png","image/octet-stream");e.setAttribute("href",t)}function changeContrast(e){rescanvas.filter="contrast("+e+"%)",rescanvas.drawImage(image,0,0,canvas.clientWidth,canvas.clientHeight)}function changeBrightness(e){rescanvas.filter="contrast("+e+"%)",rescanvas.drawImage(image,0,0,canvas.clientWidth,canvas.clientHeight)}function changeSaturate(e){rescanvas.filter="saturate("+e+"%)",rescanvas.drawImage(image,0,0,canvas.clientWidth,canvas.clientHeight)}function changeGrayscale(e){rescanvas.filter="grayscale("+e+"%)",rescanvas.drawImage(image,0,0,canvas.clientWidth,canvas.clientHeight)}canvas=document.getElementById("canvas"),cropWidth=canvas.width,cropHeight=canvas.height,rescanvas=canvas.getContext("2d");let resizeBtn=getElem("#resize"),cancelResizeBtn=getElem("#cancelResize"),cropBtn=getElem("#crop");function init(){isEditable&&(canvas.addEventListener("mousedown",mouseDown,!1),canvas.addEventListener("mouseup",mouseUp,!1),canvas.addEventListener("mousemove",mouseMove,!1))}function point(e,t){return{x:e,y:t}}function dist(e,t){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function getHandle(e){return dist(e,point(rect.x,rect.y))<=handlesSize?"topleft":dist(e,point(rect.x+rect.w,rect.y))<=handlesSize?"topright":dist(e,point(rect.x,rect.y+rect.h))<=handlesSize?"bottomleft":dist(e,point(rect.x+rect.w,rect.y+rect.h))<=handlesSize?"bottomright":dist(e,point(rect.x+rect.w/2,rect.y))<=handlesSize?"top":dist(e,point(rect.x,rect.y+rect.h/2))<=handlesSize?"left":dist(e,point(rect.x+rect.w/2,rect.y+rect.h))<=handlesSize?"bottom":dist(e,point(rect.x+rect.w,rect.y+rect.h/2))<=handlesSize&&"right"}function mouseDown(e){currentHandle&&(drag=!0),draw()}function mouseUp(){drag=!1,currentHandle=!1,draw()}function mouseMove(e){var t=currentHandle;if(drag||(currentHandle=getHandle(point(e.pageX-this.offsetLeft,e.pageY-this.offsetTop))),currentHandle&&drag){var a=point(e.pageX-this.offsetLeft,e.pageY-this.offsetTop);switch(currentHandle){case"topleft":rect.w+=rect.x-a.x,rect.h+=rect.y-a.y,rect.x=a.x,rect.y=a.y;break;case"topright":rect.w=a.x-rect.x,rect.h+=rect.y-a.y,rect.y=a.y;break;case"bottomleft":rect.w+=rect.x-a.x,rect.x=a.x,rect.h=a.y-rect.y;break;case"bottomright":rect.w=a.x-rect.x,rect.h=a.y-rect.y;break;case"top":rect.h+=rect.y-a.y,rect.y=a.y;break;case"left":rect.w+=rect.x-a.x,rect.x=a.x;break;case"bottom":rect.h=a.y-rect.y;break;case"right":rect.w=a.x-rect.x}}(drag||currentHandle!=t)&&draw()}function draw(){if(rescanvas.clearRect(0,0,canvas.width,canvas.height),rescanvas.drawImage(image,0,0),rescanvas.fillStyle="white",rescanvas.globalAlpha=.5,rescanvas.fillRect(rect.x,rect.y,rect.w,rect.h),rescanvas.globalAlpha=1,currentHandle){var e=point(0,0);switch(currentHandle){case"topleft":e.x=rect.x,e.y=rect.y,cropX=rect.x,cropY=rect.y;break;case"topright":e.x=rect.x+rect.w,e.y=rect.y,cropY=rect.y;break;case"bottomleft":e.x=rect.x,e.y=rect.y+rect.h,cropX=rect.x;break;case"bottomright":e.x=rect.x+rect.w,e.y=rect.y+rect.h;break;case"top":e.x=rect.x+rect.w/2,e.y=rect.y,cropY=rect.y;break;case"left":e.x=rect.x,e.y=rect.y+rect.h/2,cropX=rect.x;break;case"bottom":e.x=rect.x+rect.w/2,e.y=rect.y+rect.h;break;case"right":e.x=rect.x+rect.w,e.y=rect.y+rect.h/2}cropWidth=rect.w,cropHeight=rect.h,rescanvas.globalCompositeOperation="xor",rescanvas.beginPath(),rescanvas.arc(e.x,e.y,handlesSize,0,2*Math.PI),rescanvas.fill(),rescanvas.globalCompositeOperation="source-over"}}resizeBtn.addEventListener("click",function(){isEditable=!isEditable,init(),draw(),resizeBtn.style.display="none",cancelResizeBtn.style.display="block",cancelResizeBtn.classList.remove("hidden"),cropBtn.style.display="block",cropBtn.classList.remove("hidden")}),cancelResizeBtn.addEventListener("click",function(){isEditable=!1,canvas.removeEventListener("mousedown",mouseDown,!1),canvas.removeEventListener("mouseup",mouseUp,!1),canvas.removeEventListener("mousemove",mouseMove,!1),resizeBtn.style.display="block",cancelResizeBtn.style.display="none",cancelResizeBtn.classList.add("hidden"),cropBtn.style.display="none",cropBtn.classList.add("hidden"),rescanvas.clearRect(0,0,canvas.width,canvas.height),rescanvas.drawImage(image,0,0)}),cropBtn.addEventListener("click",function(){isEditable=!1,canvas.removeEventListener("mousedown",mouseDown,!1),canvas.removeEventListener("mouseup",mouseUp,!1),canvas.removeEventListener("mousemove",mouseMove,!1),resizeBtn.style.display="block",resizeBtn.classList.remove("hidden"),cancelResizeBtn.style.display="none",cancelResizeBtn.classList.add("hidden"),cropBtn.style.display="none",cropBtn.classList.add("hidden"),rescanvas.clearRect(0,0,canvas.width,canvas.height),rescanvas.drawImage(image,cropX,cropY,cropWidth,cropHeight,0,0,canvas.width,canvas.height),(image=new Image).width=canvas.width,image.height=canvas.height,image.src=canvas.toDataURL(),cropX=cropY=0,cropWidth=canvas.width,cropHeight=canvas.height,rect={x:10,y:10,w:canvas.width-20,h:canvas.height-20}}),rect={x:10,y:10,w:canvas.width-20,h:canvas.height-20},handlesSize=8,currentHandle=!1,drag=!1;